<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pakar: Rekomendasi Laptop V4</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <style>
        .toolbar-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--glass-border);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .cyber-pagination .page-link {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary-neon);
            color: var(--text-main);
            font-family: 'Orbitron';
            margin: 0 5px;
            border-radius: 5px;
        }
        .cyber-pagination .page-item.active .page-link {
            background: var(--primary-neon);
            color: black;
            box-shadow: 0 0 10px var(--primary-neon);
        }
        .cyber-pagination .page-link:hover {
            background: var(--secondary-neon);
            color: white;
        }
        
        /* Select & Input Styling */
        .cyber-select {
            background: black;
            color: var(--primary-neon);
            border: 1px solid var(--primary-neon);
            padding: 8px 15px;
            font-family: 'Rajdhani';
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
        }
        .cyber-text-input {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary-neon);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-family: 'Rajdhani';
            width: 100%;
        }
        .cyber-text-input::placeholder { color: #555; }
    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>

    <div id="loading-overlay">
        <div class="loader-ring"></div>
        <div class="loading-text">PROCESSING DATA</div>
        <div class="console-logs" id="console-logs"></div>
    </div>

    <div class="header-bg cyber-header text-center">
        <div class="container animate__animated animate__fadeInDown">
            <h1 class="glitch-title">LAPTOP<span style="color:var(--primary-neon)">EXPERT</span></h1>
            <p class="subtitle">ADVANCED DECISION SUPPORT SYSTEM</p>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="glass-panel animate__animated animate__fadeInUp">
                    <h4 class="mb-4" style="color: white; font-family:'Orbitron';"><i class="fas fa-sliders-h me-2"></i> PARAMETERS</h4>
                    
                    <form method="POST" action="/" id="expert-form">
                        
                        <input type="hidden" id="page" name="page" value="1">
                        <input type="hidden" id="category" name="category" value="{{ last_cat }}">
                        <input type="hidden" id="sub_category" name="sub_category" value="{{ last_sub }}">
                        <input type="hidden" id="sort_option" name="sort_option" value="{{ current_sort }}">
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="budget" class="form-label">MAXIMUM BUDGET (IDR)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-white">Rp</span>
                                    <input type="number" class="form-control cyber-input" id="budget" name="budget" 
                                           placeholder="e.g. 15000000" value="{{ last_budget }}" required>
                                </div>
                                <small id="budget-preview" style="color: var(--primary-neon); font-size: 0.8em;">Rp 0</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">KEYWORD SEARCH (OPTIONAL)</label>
                                <input type="text" class="cyber-text-input" name="search_query" 
                                       placeholder="e.g. Legion, ROG, Pavilion" value="{{ last_search }}">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">BRAND FILTER</label>
                            <select class="form-select cyber-select" name="brand_filter" style="width: 100%;">
                                <option value="ALL" {% if last_brand == 'ALL' %}selected{% endif %}>-- ALL BRANDS --</option>
                                {% for brand in brands %}
                                <option value="{{ brand }}" {% if last_brand == brand %}selected{% endif %}>{{ brand }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">MAIN CATEGORY</label>
                            <div class="category-grid">
                                <div class="cat-card" onclick="selectCategory('ADMIN_PELAJAR', this)">
                                    <i class="fas fa-graduation-cap cat-icon text-info"></i>
                                    <div class="fw-bold">STUDENT / OFFICE</div>
                                </div>
                                <div class="cat-card" onclick="selectCategory('PROGRAMMER_CODING', this)">
                                    <i class="fas fa-code cat-icon text-warning"></i>
                                    <div class="fw-bold">PROGRAMMER</div>
                                </div>
                                <div class="cat-card" onclick="selectCategory('DESAIN_VIDEO', this)">
                                    <i class="fas fa-pen-nib cat-icon text-danger"></i>
                                    <div class="fw-bold">CREATOR</div>
                                </div>
                                <div class="cat-card" onclick="selectCategory('GAMING_BERAT', this)">
                                    <i class="fas fa-gamepad cat-icon text-success"></i>
                                    <div class="fw-bold">GAMER</div>
                                </div>
                                <div class="cat-card" onclick="selectCategory('SHOW_ALL', this)" style="border-color: #fff;">
                                    <i class="fas fa-globe cat-icon text-white"></i>
                                    <div class="fw-bold">SHOW ALL</div>
                                </div>
                            </div>
                        </div>

                        <div id="sub-cat-container" class="mb-4 animate__animated animate__fadeIn" style="display:none;">
                            <label class="form-label">SPECIFIC USE CASE</label>
                            <div class="category-grid" id="sub-cat-grid"></div>
                        </div>

                        <div class="d-grid mt-5">
                            <button type="button" onclick="submitSearch()" class="btn-cyber">
                                ANALYZE SPECIFICATIONS <i class="fas fa-microchip ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% if error %}
            <div class="alert alert-danger text-center shadow-lg mt-4 animate__animated animate__shakeX" 
                 style="background: rgba(220, 53, 69, 0.2); border: 1px solid #dc3545; color: #ff8b94;">
                <i class="fas fa-exclamation-triangle me-2"></i> <strong>SYSTEM ALERT:</strong> {{ error }}
            </div>
        {% endif %}

        {% if recommendations %}
            <div class="mt-5 pt-3">
                <h3 class="mb-4 text-center" style="font-family: 'Orbitron'; letter-spacing: 2px;">
                    <span style="color: var(--primary-neon)">>></span> TARGETS ACQUIRED <span style="color: var(--primary-neon)"><<</span>
                </h3>

                <div class="toolbar-panel animate__animated animate__fadeIn">
                    <div style="font-family:'Orbitron'; color:white;">
                        FOUND <span style="color:var(--secondary-neon)">MANY</span> UNITS
                    </div>
                    <div>
                        <span class="me-2 text-muted">SORT BY:</span>
                        <select class="cyber-select" onchange="changeSort(this.value)">
                            <option value="score" {% if current_sort == 'score' %}selected{% endif %}>Highest Score</option>
                            <option value="lowest_price" {% if current_sort == 'lowest_price' %}selected{% endif %}>Lowest Price</option>
                            <option value="highest_price" {% if current_sort == 'highest_price' %}selected{% endif %}>Highest Price</option>
                            <option value="best_value" {% if current_sort == 'best_value' %}selected{% endif %}>Best Value</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-4">
                    {% for laptop in recommendations %}
                    <div class="col-md-6 col-lg-4 result-container">
                        <div class="tech-card js-tilt">
                            <div class="card-header-tech">
                                <h5 class="product-name" title="{{ laptop.Nama_Produk }}">{{ laptop.Nama_Produk }}</h5>
                            </div>
                            <div class="tech-body">
                                <div class="spec-grid">
                                    <span class="tech-badge"><i class="fas fa-memory"></i> {{ laptop.RAM|int }}GB</span>
                                    <span class="tech-badge"><i class="fas fa-hdd"></i> {{ laptop.Storage_GB|int }}GB</span>
                                    {% if laptop.RefreshRate > 60 %}
                                    <span class="tech-badge" style="color:var(--secondary-neon); border-color:var(--secondary-neon)">{{ laptop.RefreshRate }}Hz</span>
                                    {% endif %}
                                    <span class="tech-badge" style="border-color: #aaa; color: #aaa;">{{ laptop.Nama_Produk.split()[0] }}</span>
                                </div>

                                <div class="mt-2 mb-3">
                                    <div class="detail-row">
                                        <div class="detail-icon"><i class="fas fa-microchip"></i></div>
                                        <div>{{ laptop.TipeProcessor }}</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="detail-icon"><i class="fas fa-vr-cardboard"></i></div>
                                        <div>{{ laptop.TipeGPU }}</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="detail-icon"><i class="fas fa-desktop"></i></div>
                                        <div style="font-size:0.85em">{{ laptop.DetailLayar }}</div>
                                    </div>
                                </div>

                                <div class="tech-price">
                                    Rp {{ "{:,.0f}".format(laptop.Estimasi_Rupiah).replace(',', '.') }}
                                </div>
                                
                                <div class="ai-terminal">
                                    <i class="fas fa-terminal me-1"></i> {{ laptop.Penjelasan_AI }}
                                </div>

                                <div class="btn-action-group">
                                    {% if laptop.LinkPembelian and laptop.LinkPembelian != '0' %}
                                    <a href="{{ laptop.LinkPembelian }}" target="_blank" class="btn-tech-outline">
                                        <i class="fas fa-shopping-cart"></i> BUY
                                    </a>
                                    {% else %}
                                    <a href="#" class="btn-tech-outline" style="opacity:0.5;">N/A</a>
                                    {% endif %}
                                    
                                    {% if laptop.LinkPenjelasan and laptop.LinkPenjelasan != '0' %}
                                    <a href="{{ laptop.LinkPenjelasan }}" target="_blank" class="btn-tech-outline secondary">
                                        <i class="fas fa-info-circle"></i> INFO
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if total_pages > 1 %}
                <div class="d-flex justify-content-center mt-5">
                    <nav aria-label="Page navigation">
                        <ul class="pagination cyber-pagination">
                            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                                <a class="page-link" href="#" onclick="changePage({{ (current_page|int) - 1 }}); return false;">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>

                            <li class="page-item disabled">
                                <span class="page-link" style="border:none; background:transparent; color:var(--primary-neon)">
                                    PAGE {{ current_page }} / {{ total_pages }}
                                </span>
                            </li>

                            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                                <a class="page-link" href="#" onclick="changePage({{ (current_page|int) + 1 }}); return false;">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
                {% endif %}

            </div>
        {% endif %}
    </div>

    <footer class="text-center py-4">
        <small style="color: #666; font-family: 'Rajdhani';">
        SYSTEM V4.0 | LAPTOP RECOMENDER EXPERT SYSTEM
        </small>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js"></script>

    <script>
        const subCategoriesData = {
            "ADMIN_PELAJAR": [ { id: "umum", label: "General Tasks", desc: "Office, Browsing" }, { id: "spesifik", label: "Science / Data", desc: "Matlab, SPPS" } ],
            "PROGRAMMER_CODING": [ { id: "web_mobile", label: "Web & Mobile Dev", desc: "Android Studio, Docker" }, { id: "machine_learning", label: "AI & ML", desc: "Deep Learning (GPU)" } ],
            "DESAIN_VIDEO": [ { id: "ui_ux", label: "UI/UX Design", desc: "Figma, Photoshop" }, { id: "video_editing", label: "Video Editor / 3D", desc: "Premiere, Blender" } ],
            "GAMING_BERAT": [ { id: "indie", label: "Casual / Indie", desc: "Valorant, Genshin" }, { id: "esport_stream", label: "Esports & Stream", desc: "High FPS, OBS" }, { id: "aaa_high", label: "AAA Hardcore", desc: "Cyberpunk, RT" } ],
            "SHOW_ALL": [] // Kosong, logic ditangani khusus
        };

        function selectCategory(catValue, element) {
            document.getElementById('category').value = catValue;
            document.querySelectorAll('.cat-card').forEach(c => c.classList.remove('active'));
            element.classList.add('active');
            
            // Logic Show All: Sembunyikan sub kategori dan set default
            if(catValue === "SHOW_ALL") {
                document.getElementById('sub-cat-container').style.display = 'none';
                document.getElementById('sub_category').value = 'all'; // Default value agar form valid
            } else {
                renderSubCategories(catValue);
            }
        }

        function renderSubCategories(catValue) {
            const container = document.getElementById('sub-cat-container');
            const grid = document.getElementById('sub-cat-grid');
            const hiddenInput = document.getElementById('sub_category');
            
            grid.innerHTML = '';
            hiddenInput.value = ''; 
            
            if (subCategoriesData[catValue]) {
                container.style.display = 'block';
                subCategoriesData[catValue].forEach(sub => {
                    const div = document.createElement('div');
                    div.className = 'cat-card sub-card';
                    div.innerHTML = `<div class="fw-bold" style="color:var(--primary-neon)">${sub.label}</div><small class="text-muted" style="font-size:0.7em">${sub.desc}</small>`;
                    div.onclick = function() {
                        hiddenInput.value = sub.id;
                        document.querySelectorAll('.sub-card').forEach(c => c.classList.remove('active'));
                        div.classList.add('active');
                    };
                    grid.appendChild(div);
                });
            } else { container.style.display = 'none'; }
        }

        function submitSearch() {
            document.getElementById('page').value = 1;
            document.getElementById('expert-form').submit();
        }

        function changeSort(sortVal) {
            document.getElementById('sort_option').value = sortVal;
            document.getElementById('page').value = 1;
            document.getElementById('expert-form').submit();
        }

        function changePage(pageNum) {
            document.getElementById('page').value = pageNum;
            document.getElementById('expert-form').submit();
        }

        document.addEventListener("DOMContentLoaded", function() {
            const lastCat = "{{ last_cat }}";
            const lastSub = "{{ last_sub }}";
            if (lastCat) {
                const catEl = document.querySelector(`[onclick*="${lastCat}"]`);
                if (catEl) selectCategory(lastCat, catEl);
                
                // Jika bukan SHOW_ALL, pilih sub kategori
                if (lastCat !== "SHOW_ALL") {
                    setTimeout(() => {
                        if (lastSub) {
                            const subIndex = subCategoriesData[lastCat].findIndex(s => s.id === lastSub);
                            const subCards = document.querySelectorAll('.sub-card');
                            if(subCards[subIndex]) subCards[subIndex].click();
                        }
                    }, 100);
                }
            }
            VanillaTilt.init(document.querySelectorAll(".js-tilt"), { max: 5, speed: 400, glare: true, "max-glare": 0.2 });
        });

        const budgetInput = document.getElementById('budget');
        budgetInput.addEventListener('input', (e) => {
            const v = e.target.value;
            document.getElementById('budget-preview').textContent = v ? new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(v) : "Rp 0";
        });
        budgetInput.dispatchEvent(new Event('input'));

        document.getElementById('expert-form').addEventListener('submit', function() {
            document.getElementById('loading-overlay').style.display = 'flex';
        });

        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();
        class P { constructor(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.vx=(Math.random()-.5); this.vy=(Math.random()-.5); } update(){ this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>canvas.width)this.vx*=-1; if(this.y<0||this.y>canvas.height)this.vy*=-1; } }
        for(let i=0; i<60; i++) particles.push(new P());
        function anim(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='rgba(0, 243, 255, 0.5)'; particles.forEach(p=>{ p.update(); ctx.beginPath(); ctx.arc(p.x,p.y,1,0,Math.PI*2); ctx.fill(); particles.forEach(p2=>{ let d = Math.hypot(p.x-p2.x, p.y-p2.y); if(d<100){ ctx.strokeStyle=`rgba(100,100,255,${1-d/100})`; ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); } }); }); requestAnimationFrame(anim); }
        anim();
    </script>
</body>
</html>